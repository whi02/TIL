# PART 06

## 스위치와 브리지

### 스패닝 트리 STP(Spanning Tree Protocol)

스패닝 트리 알고리즘은 스위치나 브리지에서 발생하는 루핑을 막아주기 위한 프로토콜 이다.

CCAN STP 강의

https://www.youtube.com/watch?v=6MW5P6Ci7lw&t

**스패닝트리 프로토콜을 기억하려면?**

1. 루트 브리지가 아닌 나머지 모든 브리지(Non Root Bridge)는 무조건 하나씩의 루트 포트(Root Port)를 갖는다.
    1. 네트워크당 하나의 루트 브리지(Root Bridge)를 갖는다.
    
    루트 포트는 루트 브리지 쪽에 가장 가까운 포트라고 할 수 있다. 따라서 네트워크당 하나씩의 루트 브리지가 있으므로 루트 브리지를 제외한 나머지는  Non Root Bridge가 된다.
    
2. 세그먼트 (segment)당 하나씩의 데지그네이티드 포트(Designated Port)를 갖는다.
    
    세그먼트란 브리지 또는 스위치 간에 서로 연결된 링크이다.
    

**루핑** : 스위치나 브리지 구성에서 출발지부터 목적지까지의 경로가 2개 이상 존재할 때 1개의 경로 만을 남겨두고 나머지는 모두 끊어 놓았다가 사용하던 경로에 문제가 발생하면 그때 경로를 하나씩 살리는 것이다.

STP는 두 가지로 나눌 수 있다.

1. 브리지 ID (Bridge ID)
2. Path Cost

### 브리지 ID

브리지 ID란, 브리지나 스위치들이 통신할 때  서로를 확인하기 위해 하나씩 가지고 있는 번호   이다.

브리지 ID는 16비트의 브리지 우선순위와 48비트의 맥 어드레스로 만들어진다.

우선순위 (Bredge Priority) 는 16비트로 만들어지기 때문에 2^16 - 1까지 나타낼 수 있다.
하지만 Bredge Priority는 디폴트로 그 중간 값인  32768을 사용한다.

즉 아무런 구성을 하지 않은 스위치, 브리지에서 Bredge Priority는 32768이다.
또한 Priority는 낮은 값이 더 높은 우선순위를 가진다.

Bredge Priority 뒤에 오는 맥 어드레스는 이미 배운 대로 스위치에 고정되어 있는 값이다.

### Path Cost

Path Cost란, 브리지가 얼마나 가까이, 그리고 빠른 링크로 연결되어있는지 알아내기 위한 값이다.
Path Cost는 링크의 속도 (대역폭)가 빠르면 값이 작다. 즉, 링크 속도가 빠르면 그만큼 빨리 도착하기 때문에 Past Cost가 적게 든다.

1000을 자기 속도로 나눈 값을 사용하였는데 다양한 속도가 나오면서 소숫점이 나오는 경우가 생겼다.
따라서 IEEE에서는 소수점이 나오지 않도록 각 속도마다 다음 표와 같은 Past Cost 값을 정의하게 되었다.

| Bandwidth(대역폭) | STP Cost(Path Cost) |
| --- | --- |
| 10Gbps | 2 |
| 1Gbps | 4 |
| 622Mbps | 6 |
| 155Mbps | 14 |
| 100Mbps | 19 |
| 45Mbps | 39 |
| 16Mbps | 62 |
| 10Mbps | 100 |
| 4Mbps | 250 |

## 스위치에서 Root 브리지 뽑기

BID가 가장 낮은 값을 가지고 있는 브리지가 루트 브리지가 된다. 중요한 건 브리지나  맨 처음 부팅해서 루트 브리지를 찾아내는 과정이다.

만약 스위치 C를 꼭 루트 브리지로 만들고 싶다면 C의 BID 가 A의 BID보다 작게 생성하면 된다.

## 스패닝 트리 프로토콜 안의 순서

스패닝 트리 프로토콜안의 순서를 알아보자.

- 단계 1 : 누가 더 작은 Root BID를 가졌는가
- 단계 2 : 루트 브리지까지의  PATH Cost 값은 누가 더 작은가?
- 단계 3 : 누구의 포트 ID가 더 낮은가?

## Non Root Bridge의 루트 포트 선출기

Root Path Cast는 쉽게 루트 브리지 까지의 Path Cast 라고 생각하면 된다. 따라서 맨 처음 루트 브리지 스위치를 출발할 때 Root Path Cost는 0이다.

이후 Root Path Cast를 계산한 후 루트 포트를 선정할 수 있다. (Root Path Cast 값이 낮은 스위치의 포트를 선정한다.)

## 스패닝 트리 프로토콜의 5가지 상태 변화

Disabled : 이 상태는 포트가 고장나서 사용할 수 없거나 네트워크 관리자가 포트를 일부러 Shut Down 시켜 놓은 상태이다.

- 데이터 전송은 되지 않는다.
- 맥 어드레스를 배울 수 없다.
- BPDU를 주고받을 수 없다.

Blocking : 스위치를 맨 처음 켜거나 Disabled 되어 있는 포트를 관리자가 다시 살렸을 때 그 포트는 블로킹 상태에 들어간다.

- 데이터 전송은 되지 않는다.
- BPDU만 주고 받을 수 있다.
- 데이터 전송이 되지 않는다.
- 맥 어드레스를 배우지 못한다.

Listening : 블로킹 상태에 있던 스위치 포트가 루트 포트나 데지그네이티드 포트로 선정되면 포트는 바로 리스닝 상태로 넘어간다.

- 데이터 전송은 되지 않는다.
- 맥 어드레스를 배우지 못한다.
- BPDU를 주고받을 수 없다.

Learning : 리스닝 상태에 있던 스위치 포트가 포워딩 딜레이 (Fowarding Dealy) 디폴트 시간인 15초 동안 그 상태를 유지하면 리스닝 상태는 러닝 상태로 넘어간다.

- 데이터 전송은 되지 않는다.
- 맥 어즈레스를 배울 수 있다.
- BPDU를 주고받을 수 있다.

Forwarding : 스위치 포트가 러닝 상태에서 다른 상태로 넘어가지 않고 다시 포워딩 딜레이 디폴트 시간인 15초 동안 유지하면 포워딩 상태로 넘어가게 된다.

- 데이터 전송이 시작된다.
- 맥 어드레스를 배워 브리지 테이블을 만든다.
- BPDU를 주고 받을 수 있다.

## 스패닝 트리에 변화가 생겼을 때

만약 Non Root Bridge들이 지정된 시간동안 패킷을 받지 못하면 중간 경로 문제가 생겼다고 판단 후 스패닝 트리 재편성을 하게된다.

### 스패닝 트리 재편성 용어

1. Hello Time (헬로 타임) : 루트 브리지가 얼마 만에 한번 씩 헬로 BPDU를 보내는지에 대한 시간이다.
2. Max Age (맥스 에이지) : 브리지들이 루트 브리지로부터 얼마 동안 헬로패킷을 받지 못했을 때 새로운 스패닝 트리를 만들기 시작하는가에 대한 시간이다.
3. Forwarding Delay (포워딩 딜레이) : 브리지 포트가 블로킹 상태에서 포워딩 상태로 넘어갈 때 까지 걸리는 시간이다.

본격적으로 스패닝 트리 재편성에 대해 공부해보자.

1. 맨 처음 루트 브리지로 부터 헬로패킷을 2초마다 받던 스위치 C에 갑자기 헬로패킷이 들어오지 않게 된다.
2. 참을성 많은 스위치 C는 자신의 맥스 에이지 시간인 20초 동안 루트 브리지로부터의 헬로패킷을 기다려보지만, 20초가 지나도 헬로패킷은 E0 포트로 들어오지 않는다.
3. 이렇게 되자 스위치 C는 스위치 B에서 전달해 준 헬로패킷을 자신의 E1 포트로 받아들여 E1 포트를 루트 포트로 세팅하게 된다.
4. 물론 Non Designated 포트로 블로킹 상태에 있던 스위치 C의 E1 포트를 루트 포트로 선정했다고 해서 바로 포워딩 상태로 넘어가는 것은 아니다. 디폴트 포워딩 딜레이 시간인 15초를 리스닝 상태에서 기다리고, 다시 한 번 러닝 상태에서 15초를 기다린 후 데이터 전송이 가능한 포워딩 상태로 넘어가게 된다. 이때 기존의 루트 포트로 포워딩 상태였던 스위치 C의 E0 포트는 블로킹이 된다.

## 카타리스트 스위치

## 가상의 랜(Virtual LAN)

VLAN을 사용하면 한 대의 스위치를 마치 여러대의 분리된 스위치처럼 사용하고, 또 여러 개의 네트워크 정보를 하나의 포트를 통해 전송할 수 있다. 이러한 가상 랜을 이용하면 하나의 스위치에 연결된 장비들도 브로드캐스트 도메인이 서로 다를 수 있다.

스위치가 절약되고, 라우터에도 인터페이스가 하나만 필요하기 때문에 이익이 된다.

### VLAN에서 기억해야할 것

1. VLAN은 허브나 브리지 라우터에서 지원하지 않는다.
2. VLAN은 한 대의 스위치를 여러 개의 네트워크로 나누기 (브로드캐스트 도메인을 나눈다) 위해 사용한다.
3. VLAN 간의 통신은 오직 라우터를 통해서만 가능하다.
4. 스위치 안에 있는 각각의 스위치를 VLAN이라고 한다.
5. 트렁크에서 패킷이 전송될 때는 패킷에 VLAN 정보도 같이 전송된다.

스태틱 VLAN : 가장 일반적인 방식으로 스위치의 각 포트들을 원하는 VLAN에 하나씩 배정해 주면 된다.

다이내믹 VLAN : 스태틱 VLAN처럼 포트별로 고정 VLAN을 배정하는 것이 아닌 그 포트에 접속하는 장비의 맥 어드레스를 보고 그 주소에 따라 VLAN을 달리 배정하는 것이다.

## VLAN에서의 트렁킹과 VTP

트렁킹은 여러 개의 VLAN을 한번에 전송하는 방식이다.

VLAN들은 트렁킹에 자기들의 패킷을 태울 때 이름을 붙혀 주는데 이 이름을 붙여주는 방식이 2가지로 나뉜다.

1. ISL 트렁킹 : 시스코에서 만든 트렁킹 프로토콜이다. (비표준)
2. IEEE 802.1Q : 트렁킹에 대한 표준 프로토콜이다. 네이티브 VLAN 라는 것이 있다.

### 네이티브 VLAN

- 네이티브 VLAN은 이름을 붙이지 않는다. (VLAN 정보를 붙이지 않고 보내는 VLAN

### ISL(Inter-Switch Link)

- 스위치와 스위치 간의 링크, 스위치와 라우터 간의 링크에서 여러개의 VLAN 정보를 함께 전달하는 방식이다.

### VTP

- 스위치들 간에 VLAN 정보를 서로 주고받아 스위치들이 가지고 있는 VLAN 정보를 항상 일치 시켜 주기 위한 프로토콜이다.
- VTP 기능이 없다면 각 스위치의 구성에 들어가 VLAN을 변경하거나 지워주어야 한다.

VTP 간에 주고받는 메시지는 3가지 형식으로 구분된다.

1. Summary Advertisement : 관리하는 VTP 도메인의 구성에 대한 Revision 넘버(Revision Number)를 보낸다.
2. Subset Advertisement : VLAN의 구성이 변경되었을 때나 VTP 클라이언트로부터 Advertisement Request 메시지를 받았을 때 전송한다.
3. Advertisement Request : 클라이언트가 VTP 서버에 Summary Advertisement와 Subset Advertisement를 요청하는 용도로 사용한다.

### VTP의 3가지 모드

1. VTP 서버 모드 : VLAN을 생성, 삭제 이름 변경을 할 수 있다. 또한 VTP 도메인 안에 있는 나머지 스위치 들에게 VTP 도메인 이름과 구성을 Configuration Revision number를 전달 할 수 있습니다.
2. VTP 클라이언트 모드 : VTP 서버가 전달해준 VLAN 정보를 받고, 또 받은 정보를 자기와 연결된 다른 쪽 스위치에 전달할 수 있다. 스위치가 리부팅 된다면 모든 VLAN 정보를 잃게 된다.
3. VTP 트랜스페어런트 모드 : VTP 영역 안에 있지만 서버로 부터 메시지를 받아 VLAN을 업데이트 하거나 정보로 다른 스위치에 연결하지 않는다. 따라서 직접 VLAN을 만들고, 삭제할 수 있고,자신의 것은 다른 스위치에 공유하지 않는다.

## VLAN의 구성

1. VTP 도메인 이름 생성
2. VTP 모드 설정
3. VLAN 구성 (새로운 VLAN 생성, 해당 VLAN에 포트를 지정)